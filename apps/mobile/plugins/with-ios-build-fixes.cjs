/* global require, module */
/**
 * Expo config plugin to fix iOS build warnings.
 *
 * Patches the Podfile generated by `npx expo prebuild` to suppress:
 *
 * 1. "ld: ignoring duplicate libraries: '-lc++'"
 *    - Duplicate `-lc++` entries in OTHER_LDFLAGS.
 *    - Fix: deduplicate the array in post_install.
 *
 * 2. "Run script build phase 'Replace Hermes …' will be run during every build"
 *    - Missing output declarations on Hermes script phase.
 *    - Fix: set `always_out_of_date = '0'` on the phase in post_install.
 */
const { withPodfile, createRunOncePlugin } = require("expo/config-plugins");

// ---------------------------------------------------------------------------
// Podfile — duplicate -lc++ and Hermes "always out of date" warnings
// ---------------------------------------------------------------------------
const PODFILE_SNIPPET = `
    # [with-ios-build-fixes] Remove duplicate -lc++ linker flags
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |bc|
        ldflags = bc.build_settings['OTHER_LDFLAGS']
        if ldflags.is_a?(Array)
          bc.build_settings['OTHER_LDFLAGS'] = ldflags.uniq
        end
      end
    end

    # [with-ios-build-fixes] Suppress Hermes "run during every build" warning
    installer.pods_project.targets.each do |target|
      if target.name == 'hermes-engine'
        target.build_phases.each do |phase|
          if phase.is_a?(Xcodeproj::Project::Object::PBXShellScriptBuildPhase) && phase.name&.include?('Replace Hermes')
            phase.always_out_of_date = '0' if phase.respond_to?(:always_out_of_date=)
          end
        end
      end
    end`;

function withPodfileFixes(config) {
  return withPodfile(config, (cfg) => {
    let contents = cfg.modResults.contents;

    // Only inject once — guard on comment marker.
    if (contents.includes("[with-ios-build-fixes]")) {
      return cfg;
    }

    // Insert right after the react_native_post_install(...) call inside
    // the existing post_install block. We look for the closing paren of
    // that call and inject after it.
    const marker = "react_native_post_install(";
    const markerIdx = contents.indexOf(marker);

    if (markerIdx === -1) {
      // Fallback: inject before the closing `end` of the post_install block.
      const postInstallMatch = contents.match(
        /post_install\s+do\s+\|installer\|/
      );
      if (postInstallMatch) {
        const postInstallIdx = contents.indexOf(postInstallMatch[0]);
        const afterPostInstall = contents.slice(postInstallIdx);
        const endMatch = afterPostInstall.match(/\n(\s*end\s*\n\s*end)/);
        if (endMatch) {
          const insertIdx =
            postInstallIdx + afterPostInstall.indexOf(endMatch[0]);
          contents =
            contents.slice(0, insertIdx) +
            "\n" +
            PODFILE_SNIPPET +
            contents.slice(insertIdx);
        }
      }
    } else {
      // Find the closing `)` of react_native_post_install(...) call.
      // It may span multiple lines, so count parens.
      let depth = 0;
      let endIdx = markerIdx;
      for (let i = markerIdx; i < contents.length; i++) {
        if (contents[i] === "(") depth++;
        if (contents[i] === ")") {
          depth--;
          if (depth === 0) {
            endIdx = i + 1;
            break;
          }
        }
      }

      contents =
        contents.slice(0, endIdx) +
        "\n" +
        PODFILE_SNIPPET +
        contents.slice(endIdx);
    }

    cfg.modResults.contents = contents;
    return cfg;
  });
}

// ---------------------------------------------------------------------------
// Main plugin export
// ---------------------------------------------------------------------------
module.exports = createRunOncePlugin(
  withPodfileFixes,
  "with-ios-build-fixes",
  "1.0.0"
);
