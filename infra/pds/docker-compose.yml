# Local PDS Development Environment
#
# PDS_DEV_MODE=true bypasses the HTTPS requirement for localhost.
# For OAuth testing with external providers, use ngrok (pnpm setup:ngrok).
#
# Production PDS runs on Fly.io with Supabase Storage S3 for blobs.
# Local dev uses disk storage by default for simplicity.
# To test S3 locally, set PDS_BLOBSTORE_S3_* environment variables (see .pds-local.env)

services:
  pds:
    image: ghcr.io/bluesky-social/pds:latest
    container_name: trainers-pds-local
    ports:
      - "${PDS_PORT:-3001}:3000"
    environment:
      # These are set via --env-file from local-dev.sh
      PDS_HOSTNAME: ${PDS_HOSTNAME}
      PDS_PORT: ${PDS_PORT:-3000}
      PDS_DEV_MODE: ${PDS_DEV_MODE:-false}
      PDS_ADMIN_PASSWORD: ${PDS_ADMIN_PASSWORD}
      PDS_JWT_SECRET: ${PDS_JWT_SECRET}
      PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX: ${PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX}
      PDS_DATA_DIRECTORY: ${PDS_DATA_DIRECTORY:-/pds}
      # Local dev: disk storage (default) | Production: Supabase Storage S3
      PDS_BLOBSTORE_DISK_LOCATION: ${PDS_BLOBSTORE_DISK_LOCATION:-/pds/blobs}
      # Optional: S3 storage for local testing (overrides disk if set)
      PDS_BLOBSTORE_S3_ENDPOINT: ${PDS_BLOBSTORE_S3_ENDPOINT:-}
      PDS_BLOBSTORE_S3_BUCKET: ${PDS_BLOBSTORE_S3_BUCKET:-}
      PDS_BLOBSTORE_S3_REGION: ${PDS_BLOBSTORE_S3_REGION:-}
      PDS_BLOBSTORE_S3_ACCESS_KEY_ID: ${PDS_BLOBSTORE_S3_ACCESS_KEY_ID:-}
      PDS_BLOBSTORE_S3_SECRET_ACCESS_KEY: ${PDS_BLOBSTORE_S3_SECRET_ACCESS_KEY:-}
      PDS_BLOBSTORE_S3_FORCE_PATH_STYLE: ${PDS_BLOBSTORE_S3_FORCE_PATH_STYLE:-}
      PDS_DID_PLC_URL: ${PDS_DID_PLC_URL:-https://plc.directory}
      PDS_BSKY_APP_VIEW_URL: ${PDS_BSKY_APP_VIEW_URL:-https://api.bsky.app}
      PDS_BSKY_APP_VIEW_DID: ${PDS_BSKY_APP_VIEW_DID:-did:web:api.bsky.app}
      PDS_REPORT_SERVICE_URL: ${PDS_REPORT_SERVICE_URL:-https://mod.bsky.app}
      PDS_REPORT_SERVICE_DID: ${PDS_REPORT_SERVICE_DID:-did:plc:ar7c4by46qjdydhdevvrndac}
      PDS_CRAWLERS: ${PDS_CRAWLERS:-https://bsky.network}
      PDS_INVITE_REQUIRED: ${PDS_INVITE_REQUIRED:-true}
      PDS_INVITE_INTERVAL: ${PDS_INVITE_INTERVAL:-604800000}
      # Handle domains - allow trainers.gg handles in local dev
      PDS_HANDLE_DOMAINS: ${PDS_HANDLE_DOMAINS:-.trainers.gg}
    volumes:
      - pds-data:/pds
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/xrpc/_health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  pds-data:
    name: trainers-pds-local-data
