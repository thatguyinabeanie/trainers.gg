# Architecture - trainers.gg

This document describes the monorepo structure and architecture for trainers.gg.

## Monorepo Structure

```
trainers.gg/
├── apps/
│   ├── web/                        # Next.js 16 app (React 19.1)
│   │   ├── src/
│   │   │   ├── app/                # App Router pages
│   │   │   ├── components/         # App-specific components
│   │   │   ├── lib/                # App-specific utilities
│   │   │   └── styles/             # Global styles
│   │   ├── public/                 # Static assets
│   │   ├── next.config.js
│   │   ├── tailwind.config.js
│   │   ├── tsconfig.json
│   │   └── package.json
│   │
│   └── mobile/                     # Expo 54 app (React 19.1)
│       ├── src/
│       │   ├── app/                # Expo Router screens
│       │   ├── components/         # App-specific components
│       │   └── lib/                # App-specific utilities
│       ├── assets/                 # Images, fonts
│       ├── app.json
│       ├── tailwind.config.js      # NativeWind config
│       ├── tsconfig.json
│       └── package.json
│
├── packages/
│   ├── backend/                    # Convex backend
│   │   ├── convex/
│   │   │   ├── _generated/         # Auto-generated by Convex
│   │   │   ├── schema.ts           # Database schema
│   │   │   ├── users.ts            # User queries/mutations
│   │   │   ├── posts.ts            # Post queries/mutations
│   │   │   ├── profiles.ts         # Profile queries/mutations
│   │   │   ├── follows.ts          # Follow queries/mutations
│   │   │   ├── bluesky.ts          # Bluesky API actions
│   │   │   └── http.ts             # HTTP endpoints (webhooks, etc.)
│   │   ├── convex.json
│   │   ├── tsconfig.json
│   │   └── package.json
│   │
│   ├── ui/                         # Shared web UI components
│   │   ├── src/
│   │   │   ├── button.tsx
│   │   │   ├── input.tsx
│   │   │   ├── card.tsx
│   │   │   ├── avatar.tsx
│   │   │   ├── dialog.tsx
│   │   │   ├── dropdown-menu.tsx
│   │   │   ├── tabs.tsx
│   │   │   └── ... (other components)
│   │   ├── tailwind.config.js
│   │   ├── tsconfig.json
│   │   └── package.json
│   │
│   └── validators/                 # Shared Zod schemas
│       ├── src/
│       │   ├── user.ts
│       │   ├── post.ts
│       │   ├── profile.ts
│       │   └── index.ts
│       ├── tsconfig.json
│       └── package.json
│
├── tooling/
│   ├── typescript/                 # Shared TypeScript configs
│   │   ├── base.json
│   │   ├── nextjs.json
│   │   ├── expo.json
│   │   └── package.json
│   │
│   ├── eslint/                     # Shared ESLint config
│   │   ├── base.js
│   │   ├── nextjs.js
│   │   ├── expo.js
│   │   └── package.json
│   │
│   ├── prettier/                   # Shared Prettier config
│   │   ├── index.js
│   │   └── package.json
│   │
│   └── tailwind/                   # Shared Tailwind config
│       ├── theme.ts                # Design tokens
│       ├── postcss.config.js
│       └── package.json
│
├── .github/
│   └── workflows/                  # CI/CD workflows
│
├── turbo.json                      # Turborepo configuration
├── pnpm-workspace.yaml             # pnpm workspace config
├── package.json                    # Root package.json
├── .gitignore
├── .env.example                    # Environment variables template
└── README.md
```

---

## Package Dependencies

### Dependency Graph

```
                    ┌─────────────────┐
                    │    tooling/*    │
                    │ (configs only)  │
                    └────────┬────────┘
                             │ extends/uses
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  packages/ui    │ │packages/backend │ │packages/validators│
│  (web only)     │ │   (Convex)      │ │   (shared)      │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────┐
│                       apps/web                          │
│                     (Next.js 16)                        │
└─────────────────────────────────────────────────────────┘
                             │
                             │ (shares backend, validators)
                             ▼
┌─────────────────────────────────────────────────────────┐
│                      apps/mobile                        │
│                       (Expo 54)                         │
└─────────────────────────────────────────────────────────┘
```

### Package Naming Convention

All internal packages use the `@trainers` namespace:

| Package               | Name                          | Description                                |
| --------------------- | ----------------------------- | ------------------------------------------ |
| `packages/backend`    | `@trainers/backend`           | Convex schema, queries, mutations, actions |
| `packages/ui`         | `@trainers/ui`                | Web UI components (shadcn/Base UI)         |
| `packages/validators` | `@trainers/validators`        | Shared Zod validation schemas              |
| `tooling/typescript`  | `@trainers/typescript-config` | Shared TypeScript configs                  |
| `tooling/eslint`      | `@trainers/eslint-config`     | Shared ESLint configs                      |
| `tooling/prettier`    | `@trainers/prettier-config`   | Shared Prettier config                     |
| `tooling/tailwind`    | `@trainers/tailwind-config`   | Shared Tailwind theme                      |

---

## Architecture Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              CLIENTS                                      │
├────────────────────────────────┬─────────────────────────────────────────┤
│         Web (Next.js)          │           Mobile (Expo)                 │
│         React 19.1             │           React 19.1                    │
│         shadcn/Base UI         │           NativeWind                    │
└────────────────────────────────┴─────────────────────────────────────────┘
                    │                                    │
                    │ Convex React hooks                 │ Convex React hooks
                    ▼                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                            CONVEX BACKEND                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │   Queries   │  │  Mutations  │  │   Actions   │  │  HTTP Endpoints │  │
│  │  (read)     │  │  (write)    │  │ (external)  │  │  (webhooks)     │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘  │
│                              │                                            │
│                              ▼                                            │
│                    ┌─────────────────┐                                   │
│                    │  Convex Database │                                   │
│                    │   (users, etc.)  │                                   │
│                    └─────────────────┘                                   │
└──────────────────────────────────────────────────────────────────────────┘
                    │
                    │ Convex Actions (server-side)
                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                         BLUESKY / AT PROTOCOL                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │  Bluesky PDS    │  │  Bluesky API    │  │  AT Protocol Services   │  │
│  │  (user data)    │  │  (app.bsky.*)   │  │  (identity, feed, etc.) │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Key Architecture Decisions

### 1. Convex as Backend

Convex handles:

- Database storage (users, cached posts, follows)
- Server-side functions (queries, mutations)
- External API calls via Actions (Bluesky API)
- Real-time subscriptions (automatic with Convex)
- File storage (avatars, images - future)

### 2. Bluesky Integration via Actions

All Bluesky API calls go through Convex Actions:

- Keeps API keys/secrets secure on server
- Allows caching and rate limit management
- Single source of truth for Bluesky interactions
- Can add request queuing/retry logic

### 3. Shared Code Strategy

| Code Type         | Shared Between Platforms? | Location                                      |
| ----------------- | ------------------------- | --------------------------------------------- |
| Database schema   | Yes                       | `packages/backend`                            |
| Queries/Mutations | Yes                       | `packages/backend`                            |
| Validators        | Yes                       | `packages/validators`                         |
| UI Components     | No (different libs)       | `packages/ui` (web), `apps/mobile/components` |
| Business logic    | Yes (in Convex)           | `packages/backend`                            |
| Styling tokens    | Yes (Tailwind theme)      | `tooling/tailwind`                            |

### 4. React Version Handling

Since both web and mobile use React 19.1:

- Shared packages (`backend`, `validators`) don't import React directly
- UI components are platform-specific
- Convex hooks work with both React versions

---

## Turborepo Configuration

```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "dist/**", ".expo/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "dependsOn": ["^build"]
    },
    "typecheck": {
      "dependsOn": ["^build"]
    },
    "clean": {
      "cache": false
    }
  }
}
```

---

## Environment Variables

### Required Variables

| Variable                 | Description                  | Used By  |
| ------------------------ | ---------------------------- | -------- |
| `CONVEX_DEPLOYMENT`      | Convex deployment URL        | All apps |
| `NEXT_PUBLIC_CONVEX_URL` | Public Convex URL for web    | Web      |
| `EXPO_PUBLIC_CONVEX_URL` | Public Convex URL for mobile | Mobile   |

### Bluesky/OAuth Variables (when needed)

| Variable               | Description                       | Used By |
| ---------------------- | --------------------------------- | ------- |
| `BLUESKY_CLIENT_ID`    | OAuth client ID (URL to metadata) | Backend |
| `BLUESKY_REDIRECT_URI` | OAuth callback URL                | Backend |

### Deployment Variables

| Variable              | Description        | Used By |
| --------------------- | ------------------ | ------- |
| `VERCEL_URL`          | Auto-set by Vercel | Web     |
| `EXPO_PUBLIC_API_URL` | API URL for mobile | Mobile  |
